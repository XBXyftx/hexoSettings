---
title: 我的书架项目笔记
date: 2025-02-08 16:04:54
tags:
  - 鸿蒙
  - 技术向
  - 项目
  - 网络请求
cover: https://raw.githubusercontent.com/XBXyftx/hexoImgs3/main/20250208160923.png
post_copyright:
copyright_author: XBXyftx
copyright_author_href: https://github.com/XBXyftx
copyright_url: https://XBXyftx.github.io
copyright_info: 此文章版权归XBXyftx所有，如有转载，请註明来自原作者
---

## 项目简介

我的书架是一个基于鸿蒙开发的图书管理应用，用户可以通过该应用实现图书的添加、删除、借阅、归还等功能。
开源地址：[我的书架](https://github.com/XBXyftx/MyBookshelf)

本项目旨在练习鸿蒙开发中的网络请求模块，实现对后端数据的增删改查，同时熟悉V2版本的状态管理。

## 功能实现

本项目主要实现的功能有以下几项：

1. 获取图书
2. 新增图书
3. 删除图书
4. 全部删除
5. 修改图书

### 获取图书

#### 开启网络权限

在`module.json5`中开启网络请求权限

```json5
"requestPermissions": [
  {
    "name": "ohos.permission.INTERNET"
  }
],
```

随后创建网络请求对象

```ArkTS
  req: http.HttpRequest = http.createHttp()
```

#### 用V2版本的状态管理搭建UI

```ArkTS
 import { router } from '@kit.ArkUI'
import { http } from '@kit.NetworkKit'

export interface Book {
  id: number
  bookName: string
  author: string
  publisher: string
}

export const creator: string = 'XBXyftx'

@Entry
@ComponentV2
struct Day02_01_BookShelf {
  creator: string = creator
  @Local books: Book[] = [{
    id: 366351,
    bookName: "《西游记》",
    author: "吴承恩",
    publisher: "人民文学出版社"
  }]
  @Local isLoading: boolean = true
  req: http.HttpRequest = http.createHttp()
  

  build() {
    Column() {
      // 头部
      this.HeaderBuilder()
      LoadingProgress()
        .width(50)

      List({ space: 15 }) {
        ForEach(this.books, (item: Book) => {
          ListItem() {
            bookItem({ data: item })
          }
          .swipeAction({
            end: () => {
              this.itemEnd(item)
            },
            edgeEffect: SwipeEdgeEffect.Spring
          })
          .onClick(() => {

          })
        })
      }
      .padding(20)
    }
    .height('100%')
    .width('100%')
  }

  @Builder
  HeaderBuilder() {
    Row() {
      Image($r('app.media.ic_public_drawer_filled'))
        .width(20);

      Text('我的书架')
        .fontSize(25)

      Image($r('app.media.ic_public_add'))
        .width(20)
        .onClick(() => {
          router.pushUrl({
            url: 'pages/Day02_01_BookShelf_Add'
          })
        })
    }
    .width('100%')
    .justifyContent(FlexAlign.SpaceBetween)
    .height(60)
    .padding(10)
    .border({ width: { bottom: 2 }, color: '#f0f0f0' })
    .backgroundColor(Color.White)
  }

  @Builder
  itemEnd(item: Book) {
    Row() {
      Button('删除')
        .type(ButtonType.Normal)
        .backgroundColor('#da3231')
        .onClick(() => {
          AlertDialog.show({ message: '点了删除' })
        })
        .height('100%')
    }

  }
}

@ComponentV2
struct bookItem {
  @Param data: Partial<Book> = {}

  build() {
    Row({ space: 10 }) {
      Image($r('app.media.ic_public_cover'))
        .width(108)
        .height(108)
      Column({ space: 5 }) {

        Text('书名：' + this.data.bookName)
          .fontSize(20)
        Text('作者：' + this.data.author)
          .fontSize(14)
          .fontColor(Color.Gray)
        Blank()
        Text('出版社: ' + this.data.publisher)
          .fontSize(14)
          .fontColor(Color.Gray)
      }
      .padding({ top: 10, bottom: 10 })
      .height(108)
      .alignItems(HorizontalAlign.Start)
    }
  }
}
```

![1](我的书架项目笔记/1.png)

#### 获取数据格式定义接口

```ArkTS
  aboutToAppear(): void {
    this.req.request(`https://hmajax.itheima.net/api/books?creator=${this.creator}`)
      .then((res)=>{
        AlertDialog.show({message:res.result.toString()})
      })
  }
```

![2](我的书架项目笔记/2.png)

由此可以定义接口

```ArkTS
export interface Book {
  id: number
  bookName: string
  author: string
  publisher: string
}
export interface BookRes{
  message:string
  data:Book[]
}
```

于是针对数据结构进行相应的数据处理如下

```ArkTS
@Local books: Book[] = []
aboutToAppear(): void {
  this.req.request(`https://hmajax.itheima.net/api/books?creator=${this.creator}`)
    .then((res)=>{
      this.books = (JSON.parse(res.result.toString()) as BookRes).data
    })
}
```

显示效果如下
![3](我的书架项目笔记/3.png)

#### 加载效果开关

```ArkTS
    @Local isLoading: boolean = true
  
    aboutToAppear(): void {
      this.isLoading = true
      this.req.request(`https://hmajax.itheima.net/api/books?creator=${this.creator}`)
        .then((res)=>{
          this.books = (JSON.parse(res.result.toString()) as BookRes).data
          this.isLoading = false
        })
        .catch((err:string)=>{
          AlertDialog.show({
            message:err
          })
          this.isLoading = false
        })
    }

    if (this.isLoading){
        LoadingProgress()
            .width(50)
    }
```

### 新增图书

#### 跳转页面

首先从主页跳转至新增页面

```ArkTS
Image($r('app.media.ic_public_add'))
  .width(20)
  .onClick(() => {
    router.pushUrl({
      url: 'pages/AddBookPage'
    })
  })
```

#### 新增图书页面逻辑分析

UI框架如下：

```ArkTS
@Entry
@ComponentV2
struct BookShelf_Add {
  @Local bookname: string = ''
  @Local author: string = ''
  @Local publisher: string = ''

  build() {
    Navigation() {
      Column({ space: 10 }) {
        Row() {
          Text('图书姓名:')
          TextInput({
            placeholder: '请输入图书名字',
            text: $$this.bookname
          })
            .height(30)
            .backgroundColor(Color.Transparent)
            .layoutWeight(1)
            .padding({ left: 10, top: 0, bottom: 0 })
        }

        Divider()
        Row() {
          Text('图书作者:')
          TextInput({
            placeholder: '请输入图书作者',
            text: $$this.author
          })
            .height(30)
            .backgroundColor(Color.Transparent)
            .layoutWeight(1)
            .padding({ left: 10, top: 0, bottom: 0 })
        }

        Divider()
        Row() {
          Text('图书出版社:')
          TextInput({
            placeholder: '请输入图书出版社',
            text: $$this.publisher
          })
            .height(30)
            .backgroundColor(Color.Transparent)
            .layoutWeight(1)
            .padding({ left: 10, top: 0, bottom: 0 })
        }

        Divider()


        Button('保存')
          .width('100%')
          .margin({ top: 20 })
          .type(ButtonType.Normal)
          .borderRadius(10)
          .onClick(() => {
          })

      }
      .padding(20)
    }
    .title('新增图书')
    .titleMode(NavigationTitleMode.Mini)
    .backButtonIcon($r('app.media.ic_public_arrow_left'))
  }
}
```

![4](我的书架项目笔记/4.png)

在点击保存按钮之后，首先要去判断输入框是否为空，为空则提示用户输入，不为空则将数据发送至后端。

```ArkTS
.onClick(() => {
  if (this.bookname.trim() === '' || this.author.trim() === '' || this.publisher.trim() === '') {
    AlertDialog.show({
      message:'新建图书信息均不能为空'
    })
    return
  }
})
```

在不为空的情况下就可去发送请求添加书籍，并返回数据。
请求方法为Post，数据格式为json。

```ArkTS
.onClick(() => {
  if (this.bookname.trim() === '' || this.author.trim() === '' || this.publisher.trim() === '') {
    AlertDialog.show({
      message:'新建图书信息均不能为空'
    })
    return
  }
  const req = http.createHttp()
  req.request('https://hmajax.itheima.net/api/books',{
    method: http.RequestMethod.POST,
    header:{
      contentType:'application/json'
    },
    extraData:{
      bookname:this.bookname,
      author:this.author,
      publisher:this.publisher,
      creator:creator
    }
  })
    .then((res)=>{
      const addRes = JSON.parse(res.result.toString()) as AddResponse
      router.back()
      AlertDialog.show({
        message:addRes.message
      })
    })
})
```

请求是成功的但是首页的图书列表并没有更新，需要刷新页面。
这是因为`aboutToAppear`函数只在页面第一次出现时调用，而不是每次页面重新出现时调用。
所以换位`onPageShow`函数即可。

```ArkTS
  onPageShow(): void {
    this.isLoading = true
    this.req.request(`https://hmajax.itheima.net/api/books?creator=${this.creator}`)
      .then((res)=>{
        this.books = (JSON.parse(res.result.toString()) as BookRes).data
        this.isLoading = false
      })
      .catch((err:string)=>{
        AlertDialog.show({
          message:err
        })
        this.isLoading = false
      })
  }
```